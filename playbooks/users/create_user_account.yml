---
- name: Add new user to Lambda servers
  hosts: lambda
  become: true
  gather_facts: false

  vars:
    group_name: students

  pre_tasks:
    - name: Validate web-form inputs
      ansible.builtin.assert:
        that:
          - full_name is defined
          - email is defined
          - (email | lower) is match('^[a-z0-9._%+-]+@wit\.edu$')
        fail_msg: "Invalid input. Must provide full_name and a valid @wit.edu email."

    - name: Derive username (run once)
      ansible.builtin.set_fact:
        username: "{{ (email | lower).split('@')[0] | regex_replace('[^a-z0-9._-]', '') }}"
      run_once: true

    - name: Generate ONE shared temporary password (run once)
      ansible.builtin.set_fact:
        temp_password: "{{ lookup('ansible.builtin.password', '/dev/null', length=10) }}"
      run_once: true
      no_log: true

    - name: Fail if derived username is empty
      ansible.builtin.assert:
        that:
          - username | length > 0
        fail_msg: "Derived username is empty after sanitizing email."
      run_once: true

  tasks:
    - name: Ensure 'students' group exists
      ansible.builtin.group:
        name: "{{ group_name }}"
        state: present

    - name: Create or update user
      ansible.builtin.user:
        name: "{{ username }}"
        shell: /bin/bash
        create_home: true
        groups: "{{ group_name }}"
        append: true
        comment: "{{ full_name }} ({{ email }})"

    - name: Set SAME temp password everywhere (no passlib)
      ansible.builtin.shell: "echo '{{ username }}:{{ temp_password }}' | chpasswd"
      args:
        executable: /bin/bash
      no_log: true

    - name: Force password change on first login
      ansible.builtin.command: "chage -d 0 {{ username }}"

  post_tasks:
    # This collects Ansible's own internal status lists
    - name: Build JSON summary for Flask (run once)
      ansible.builtin.set_fact:
        flask_summary: >-
          {{
            {
              "ok": (ansible_failed_hosts | length == 0) and (ansible_unreachable_hosts | length == 0),
              "failed_hosts": (ansible_failed_hosts | default([])),
              "unreachable_hosts": (ansible_unreachable_hosts | default([]))
            }
          }}
      run_once: true

    - name: Print FINAL_JSON_SUMMARY for Flask (one line)
      ansible.builtin.debug:
        msg: "FINAL_JSON_SUMMARY={{ flask_summary | to_json }}"
      run_once: true
