---
- name: Add new user to Lambda servers
  hosts: lambda
  become: true
  gather_facts: false

  vars:
    group: students

  pre_tasks:
    - name: Validate required vars from Flask
      ansible.builtin.assert:
        that:
          - username is defined
          - full_name is defined
          - email is defined
          - password is defined
          - (email | lower) is match('^[a-z0-9._%+-]+@wit\.edu$')
          - (username | lower) is match('^[a-z0-9._-]+$')
        fail_msg: "Missing/invalid input. Flask must provide username, full_name, email, password and email must be @wit.edu."

    # Hash on the CONTROLLER using passlib (controller only)
    - name: Hash password for Linux user module
      ansible.builtin.set_fact:
        password_hash: "{{ password | password_hash('sha512') }}"
      no_log: true

  tasks:
    - name: Ensure 'students' group exists
      ansible.builtin.group:
        name: "{{ group }}"
        state: present

    - name: Create or update user account
      ansible.builtin.user:
        name: "{{ username }}"
        shell: /bin/bash
        create_home: true
        comment: "{{ full_name }} ({{ email }})"
        groups: "{{ group }}"
        append: true
        password: "{{ password_hash }}"

    - name: Force password change on first login
      ansible.builtin.command: "chage -d 0 {{ username }}"
      register: chage_result
      changed_when: chage_result.rc == 0

    - name: Confirmation message
      ansible.builtin.debug:
        msg: "User {{ username }} created/updated in group '{{ group }}' and must change password at first login."
